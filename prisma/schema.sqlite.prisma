// Prisma schema for SQLite (local development)
// Use with: npx prisma migrate dev --schema=prisma/schema.sqlite.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// NextAuth core models (Prisma Adapter)
model User {
  id            String   @id @default(cuid())
  name          String?
  email         String?  @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?  // For email/password authentication

  // Multi-tenancy relations
  memberships   Membership[]
  projectMembers ProjectMember[]
  customer      Customer?     // E-commerce customer profile
  inventoryLogs InventoryLog[] @relation("InventoryUserLogs")
  auditLogs     AuditLog[]     @relation("AuditUserLogs")
  
  // Vendor relationship (user can be a vendor)
  vendors       Vendor[]

  accounts      Account[]
  sessions      Session[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Multi-tenant models
model Organization {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  image       String?

  memberships Membership[]
  projects    Project[]
  store       Store?        // E-commerce store for this organization

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Membership {
  id             String        @id @default(cuid())
  userId         String
  organizationId String
  role           Role          @default(MEMBER)

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@unique([userId, organizationId])
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// Project management models
model Project {
  id             String          @id @default(cuid())
  name           String
  description    String?
  slug           String          @unique
  status         String          @default("planning") // planning, active, archived
  organizationId String

  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members        ProjectMember[]

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@index([organizationId])
  @@index([slug])
}

model ProjectMember {
  id        String   @id @default(cuid())
  projectId String
  userId    String
  role      String   @default("member") // owner, admin, member, viewer

  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([projectId, userId])
  @@index([userId])
}
// ============================================================================
// E-COMMERCE MODELS
// ============================================================================

// E-commerce enums
enum ProductStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum OrderStatus {
  PENDING
  PAYMENT_FAILED
  PAID
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  FAILED
  REFUNDED
  DISPUTED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  MOBILE_BANKING
  BANK_TRANSFER
  CASH_ON_DELIVERY
}

enum PaymentGateway {
  STRIPE
  SSLCOMMERZ
  MANUAL
}

enum InventoryStatus {
  IN_STOCK
  LOW_STOCK
  OUT_OF_STOCK
  DISCONTINUED
}

enum DiscountType {
  PERCENTAGE
  FIXED
  FREE_SHIPPING
}

// ============================================================================
// VENDOR MARKETPLACE ENUMS
// ============================================================================

enum VendorStatus {
  PENDING        // Initial application submitted
  UNDER_REVIEW   // Admin reviewing application
  APPROVED       // Vendor approved and active
  SUSPENDED      // Temporarily suspended
  REJECTED       // Application rejected
  DEACTIVATED    // Vendor deactivated their account
}

enum VendorPayoutMethod {
  BANK_TRANSFER
  BKASH
  NAGAD
  PAYPAL
  STRIPE_CONNECT
}

enum PayoutStatus {
  PENDING        // Scheduled but not yet processed
  PROCESSING     // Currently being processed
  COMPLETED      // Successfully paid out
  FAILED         // Payout failed
  ON_HOLD        // Manually held (dispute, etc.)
}

enum PayoutFrequency {
  WEEKLY
  BI_WEEKLY
  MONTHLY
}

enum VendorDocumentType {
  TRADE_LICENSE
  NID_PASSPORT
  TAX_CERTIFICATE
  BANK_STATEMENT
  OTHER
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProductApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SubscriptionPlan {
  FREE
  BASIC
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
}

// Store model (E-commerce tenant - extends Organization)
model Store {
  id             String   @id @default(cuid())
  organizationId String   @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name           String
  slug           String   @unique
  description    String?
  logo           String?
  email          String
  phone          String?
  website        String?
  
  // Address
  address        String?
  city           String?
  state          String?
  postalCode     String?
  country        String   @default("US")
  
  // Settings
  currency       String   @default("USD")
  timezone       String   @default("UTC")
  locale         String   @default("en")
  
  // Subscription
  subscriptionPlan   SubscriptionPlan   @default(FREE)
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialEndsAt        DateTime?
  subscriptionEndsAt DateTime?
  
  // Limits
  productLimit   Int      @default(10)
  orderLimit     Int      @default(100)
  
  // Marketplace settings
  isMarketplace         Boolean  @default(false)  // Enable multi-vendor marketplace mode
  defaultCommissionRate Float    @default(0.15)   // Default commission rate (15%)
  vendorAutoApprove     Boolean  @default(false)  // Auto-approve new vendors
  productAutoApprove    Boolean  @default(false)  // Auto-approve vendor products
  payoutHoldDays        Int      @default(7)      // Days to hold payment after delivery
  
  products       Product[]
  categories     Category[]
  brands         Brand[]
  orders         Order[]
  customers      Customer[]
  attributes     ProductAttribute[]
  auditLogs      AuditLog[]
  inventoryLogs  InventoryLog[] @relation("StoreInventoryLogs")
  vendors        Vendor[]
  commissionRules CommissionRule[]
  vendorPayouts  VendorPayout[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?
  
  @@index([slug])
  @@index([subscriptionPlan])
  @@index([subscriptionStatus])
  @@index([isMarketplace])
}

// Product models
model Product {
  id          String        @id @default(cuid())
  storeId     String
  store       Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  // Vendor (marketplace mode)
  vendorId    String?
  vendor      Vendor?       @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  approvalStatus ProductApprovalStatus @default(PENDING)
  approvedAt  DateTime?
  approvedBy  String?       // User ID of admin who approved
  rejectionReason String?
  
  name        String
  slug        String
  description String?
  shortDescription String?
  
  price       Float
  compareAtPrice Float?
  costPrice   Float?
  
  sku         String
  barcode     String?
  trackInventory Boolean @default(true)
  inventoryQty   Int     @default(0)
  lowStockThreshold Int  @default(5)
  inventoryStatus InventoryStatus @default(IN_STOCK)
  
  weight      Float?
  length      Float?
  width       Float?
  height      Float?
  
  categoryId  String?
  category    Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  brandId     String?
  brand       Brand?        @relation(fields: [brandId], references: [id], onDelete: SetNull)
  
  images      String        // JSON array of image URLs
  thumbnailUrl String?
  
  metaTitle       String?
  metaDescription String?
  metaKeywords    String?
  
  status      ProductStatus @default(DRAFT)
  publishedAt DateTime?
  isFeatured  Boolean       @default(false)
  
  variants    ProductVariant[]
  orderItems  OrderItem[]
  attributes  ProductAttributeValue[]
  reviews     Review[]
  inventoryLogs InventoryLog[] @relation("InventoryLogs")
  
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?
  
  @@unique([storeId, sku])
  @@unique([storeId, slug])
  @@index([storeId, status])
  @@index([storeId, categoryId])
  @@index([storeId, brandId])
  @@index([storeId, vendorId])
  @@index([categoryId, status])
  @@index([brandId, status])
  @@index([vendorId, approvalStatus])
}

model ProductVariant {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  name      String
  sku       String   @unique
  barcode   String?
  
  price     Float?
  compareAtPrice Float?
  
  inventoryQty Int @default(0)
  lowStockThreshold Int @default(5)
  
  weight    Float?
  image     String?
  options   String   // JSON object of variant options (e.g., {"size": "L", "color": "Red"})
  
  isDefault Boolean  @default(false)
  
  orderItems OrderItem[]
  inventoryLogs InventoryLog[] @relation("VariantInventoryLogs")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([productId])
  @@index([productId, isDefault])
}

model Category {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  name        String
  slug        String
  description String?
  image       String?
  
  parentId    String?
  parent      Category?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children    Category[] @relation("CategoryTree")
  
  metaTitle       String?
  metaDescription String?
  
  isPublished Boolean @default(true)
  sortOrder   Int     @default(0)
  
  products    Product[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  @@unique([storeId, slug])
  @@index([storeId, parentId])
  @@index([storeId, isPublished])
  @@index([parentId, sortOrder])
}

model Brand {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  name        String
  slug        String
  description String?
  logo        String?
  website     String?
  
  metaTitle       String?
  metaDescription String?
  
  isPublished Boolean @default(true)
  
  products    Product[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?
  
  @@unique([storeId, slug])
  @@index([storeId, isPublished])
}

model ProductAttribute {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  name      String
  values    String   // JSON array of possible values
  
  productValues ProductAttributeValue[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([storeId, name])
  @@index([storeId])
  @@index([name])
}

model ProductAttributeValue {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeId String
  attribute   ProductAttribute @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  value       String
  
  createdAt   DateTime @default(now())
  
  @@index([productId, attributeId])
}

// Customer model
model Customer {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  userId    String?  @unique
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  email     String
  firstName String
  lastName  String
  phone     String?
  
  acceptsMarketing Boolean @default(false)
  marketingOptInAt DateTime?
  
  totalOrders       Int     @default(0)
  totalSpent        Float   @default(0)
  averageOrderValue Float   @default(0)
  lastOrderAt       DateTime?
  
  orders    Order[]
  reviews   Review[]
  vendorReviews    VendorReview[]
  vendorFollowing  VendorFollower[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  @@unique([storeId, email])
  @@index([storeId, userId])
  @@index([storeId, email])
}

// Order models
model Order {
  id        String      @id @default(cuid())
  storeId   String
  store     Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  customerId String?
  customer   Customer?  @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  orderNumber String
  status      OrderStatus @default(PENDING)
  
  subtotal        Float
  taxAmount       Float @default(0)
  shippingAmount  Float @default(0)
  discountAmount  Float @default(0)
  totalAmount     Float
  
  discountCode String?
  
  paymentMethod  PaymentMethod?
  paymentGateway PaymentGateway?
  paymentStatus  PaymentStatus @default(PENDING)
  
  shippingMethod String?
  trackingNumber String?
  trackingUrl    String?
  
  shippingAddress String? // JSON object
  billingAddress  String? // JSON object
  
  fulfilledAt DateTime?
  canceledAt  DateTime?
  cancelReason String?
  
  customerNote String?
  adminNote    String?
  
  ipAddress   String?
  
  items    OrderItem[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  @@unique([storeId, orderNumber])
  @@index([storeId, customerId])
  @@index([storeId, status])
  @@index([storeId, createdAt])
  @@index([orderNumber])
  @@index([paymentStatus])
}

model OrderItem {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  
  // Vendor information (for marketplace)
  vendorId  String?
  vendor    Vendor?  @relation(fields: [vendorId], references: [id], onDelete: SetNull)
  
  productName String
  variantName String?
  sku         String
  image       String?
  
  price       Float
  quantity    Int
  subtotal    Float
  taxAmount   Float @default(0)
  discountAmount Float @default(0)
  totalAmount Float
  
  // Commission tracking (marketplace)
  commissionRate     Float   @default(0)    // Commission rate at time of order
  commissionAmount   Float   @default(0)    // Calculated commission
  vendorEarnings     Float   @default(0)    // Vendor's net earnings
  
  // Vendor fulfillment (for multi-vendor orders)
  vendorFulfilled    Boolean @default(false)
  vendorFulfilledAt  DateTime?
  vendorTrackingNumber String?
  vendorTrackingUrl  String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([orderId])
  @@index([productId])
  @@index([vendorId])
}

// Review model
model Review {
  id        String   @id @default(cuid())
  storeId   String
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  rating    Int
  title     String?
  comment   String
  images    String?  // JSON array of image URLs
  
  isApproved Boolean @default(false)
  approvedAt DateTime?
  isVerifiedPurchase Boolean @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  @@index([storeId, productId])
  @@index([productId, isApproved, createdAt])
  @@index([customerId, createdAt])
}

// Inventory log model (for audit trail)
model InventoryLog {
  id          String   @id @default(cuid())
  storeId     String
  store       Store    @relation("StoreInventoryLogs", fields: [storeId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation("InventoryLogs", fields: [productId], references: [id], onDelete: Cascade)
  variantId   String?
  variant     ProductVariant? @relation("VariantInventoryLogs", fields: [variantId], references: [id], onDelete: SetNull)
  orderId     String?
  
  previousQty Int
  newQty      Int
  changeQty   Int
  reason      String   // String value from InventoryAdjustmentReason enum (stored as raw string, not TypeScript enum)
  note        String?
  
  userId      String?
  user        User?    @relation("InventoryUserLogs", fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  
  @@index([storeId, productId, createdAt])
  @@index([productId, createdAt])
  @@index([variantId, createdAt])
  @@index([orderId])
  @@index([userId, createdAt])
  @@index([reason])
}

// Audit log model (for tracking all system actions)
model AuditLog {
  id        String   @id @default(cuid())
  storeId   String?
  store     Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?    @relation("AuditUserLogs", fields: [userId], references: [id], onDelete: SetNull)

  action    String   // e.g., "CREATE", "UPDATE", "DELETE"
  entityType String  // e.g., "Product", "Order", "User"
  entityId  String
  
  // Change tracking
  changes   String?  // JSON { "field": { "old": "value", "new": "value" } }
  
  // Request metadata
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  @@index([storeId, createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId, createdAt])
  @@map("audit_logs")
}

// ============================================================================
// VENDOR MARKETPLACE MODELS
// ============================================================================

// Vendor model (seller in marketplace)
model Vendor {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  // User association (vendor owner)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Business information
  businessName     String
  slug             String
  businessEmail    String
  businessPhone    String?
  taxId            String?    // Tax identification number
  
  // Profile
  logo             String?
  banner           String?
  description      String?
  shortDescription String?
  
  // Address
  address          String?
  city             String?
  state            String?
  postalCode       String?
  country          String     @default("US")
  
  // Banking & payout info
  payoutMethod     VendorPayoutMethod @default(BANK_TRANSFER)
  bankName         String?
  bankAccountName  String?
  bankAccountNumber String?
  bankRoutingNumber String?
  bkashNumber      String?    // Bangladesh mobile banking
  nagadNumber      String?    // Bangladesh mobile banking
  paypalEmail      String?
  stripeConnectId  String?    // Stripe Connect account ID
  
  // Commission settings (can override store default)
  commissionRate   Float?     // null = use store default
  
  // Payout settings
  payoutFrequency  PayoutFrequency @default(BI_WEEKLY)
  minimumPayout    Float      @default(50)  // Minimum balance to trigger payout
  
  // Status & verification
  status           VendorStatus @default(PENDING)
  statusReason     String?      // Reason for rejection/suspension
  appliedAt        DateTime     @default(now())
  approvedAt       DateTime?
  approvedBy       String?      // User ID of admin who approved
  
  // KYC verification
  kycVerified      Boolean    @default(false)
  kycVerifiedAt    DateTime?
  kycProvider      String?    // e.g., "stripe_identity", "manual"
  
  // Terms acceptance
  termsAcceptedAt  DateTime?
  termsVersion     String?
  
  // Statistics (denormalized for performance)
  totalProducts    Int        @default(0)
  totalOrders      Int        @default(0)
  totalSales       Float      @default(0)
  totalEarnings    Float      @default(0)
  totalPayouts     Float      @default(0)
  pendingBalance   Float      @default(0)
  averageRating    Float      @default(0)
  totalReviews     Int        @default(0)
  
  // Performance metrics
  onTimeDeliveryRate Float    @default(100)
  returnRate         Float    @default(0)
  responseTime       Int      @default(0)   // Average response time in hours
  
  // SEO
  metaTitle        String?
  metaDescription  String?
  
  // Relations
  products         Product[]
  orderItems       OrderItem[]
  documents        VendorDocument[]
  payouts          VendorPayout[]
  reviews          VendorReview[]
  followers        VendorFollower[]
  notifications    VendorNotification[]
  
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  deletedAt        DateTime?
  
  @@unique([storeId, slug])
  @@unique([storeId, userId])
  @@index([storeId, status])
  @@index([userId])
  @@index([status])
  @@index([storeId, averageRating])
}

// Vendor KYC documents
model VendorDocument {
  id        String   @id @default(cuid())
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  type      VendorDocumentType
  name      String              // Original filename or description
  url       String              // Document URL
  mimeType  String?
  fileSize  Int?
  
  status    DocumentStatus @default(PENDING)
  reviewedAt DateTime?
  reviewedBy String?      // User ID of reviewer
  rejectionReason String?
  
  expiresAt DateTime?     // Some documents may expire (e.g., licenses)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([vendorId, type])
  @@index([vendorId, status])
}

// Commission rules (tiered, category-based)
model CommissionRule {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  name      String
  
  // Rule type
  ruleType  String   // "vendor", "category", "tiered", "global"
  
  // Conditions (JSON)
  // For vendor: { "vendorId": "xxx" }
  // For category: { "categoryId": "xxx" }
  // For tiered: { "minSales": 10000, "maxSales": 20000 }
  conditions String?  // JSON
  
  // Commission
  commissionRate Float  // Rate as decimal (0.15 = 15%)
  
  // Priority (higher = evaluated first)
  priority  Int      @default(0)
  
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId, isActive])
  @@index([storeId, ruleType])
}

// Vendor payouts
model VendorPayout {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  // Payout details
  amount         Float
  currency       String     @default("USD")
  method         VendorPayoutMethod
  
  // Status
  status         PayoutStatus @default(PENDING)
  statusReason   String?
  
  // Period
  periodStart    DateTime
  periodEnd      DateTime
  
  // Transaction details
  transactionId  String?    // External payment provider transaction ID
  transactionRef String?    // Internal reference number
  
  // Breakdown (JSON)
  // { "grossSales": 1000, "commission": 150, "refunds": 20, "adjustments": 0 }
  breakdown      String?    // JSON
  
  // Processing
  processedAt    DateTime?
  processedBy    String?    // User ID or "system"
  failureReason  String?
  
  // Notes
  notes          String?
  
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  
  @@index([storeId, vendorId])
  @@index([vendorId, status])
  @@index([storeId, status])
  @@index([vendorId, periodEnd])
}

// Vendor reviews (customer reviews for vendors, not products)
model VendorReview {
  id        String   @id @default(cuid())
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  
  orderId   String?   // Optional link to order
  
  rating    Int       // 1-5
  title     String?
  comment   String
  
  // Sub-ratings (optional)
  productQualityRating  Int?  // 1-5
  deliverySpeedRating   Int?  // 1-5
  communicationRating   Int?  // 1-5
  
  // Vendor response
  vendorResponse        String?
  vendorRespondedAt     DateTime?
  
  // Moderation
  isApproved Boolean   @default(false)
  approvedAt DateTime?
  approvedBy String?
  isFlagged  Boolean   @default(false)
  flagReason String?
  
  isVerifiedPurchase Boolean @default(false)
  
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?
  
  @@index([vendorId, isApproved])
  @@index([customerId])
  @@index([vendorId, rating])
}

// Vendor followers
model VendorFollower {
  id        String   @id @default(cuid())
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  // Notification preferences
  notifyNewProducts  Boolean @default(true)
  notifyPromotions   Boolean @default(true)
  
  createdAt DateTime @default(now())
  
  @@unique([vendorId, customerId])
  @@index([vendorId])
  @@index([customerId])
}

// Vendor notifications
model VendorNotification {
  id        String   @id @default(cuid())
  vendorId  String
  vendor    Vendor   @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  type      String   // "new_order", "review", "payout", "product_approved", etc.
  title     String
  message   String
  data      String?  // JSON with additional context
  
  isRead    Boolean  @default(false)
  readAt    DateTime?
  
  // Email sent
  emailSent Boolean  @default(false)
  emailSentAt DateTime?
  
  createdAt DateTime @default(now())
  
  @@index([vendorId, isRead])
  @@index([vendorId, createdAt])
}